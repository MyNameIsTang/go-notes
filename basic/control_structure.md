## 控制结构

到目前为止，我们看到的 Go 程序都是从 main() 函数开始执行，然后按顺序执行该函数体中的代码。

- 会需要只有在满足一些特定情况时才执行某些代码，也就是说在代码里进行条件判断。

  - if-else 结构
  - switch 结构
  - select 结构，用于 channel 的选择

- 可以使用迭代或循环结构来重复执行一次或多次某段代码（任务）。

  - for (range) 结构
  - 一些如 break 和 continue 这样的关键字可以用于中途改变循环的状态。

- 还可以使用 return 来结束某个函数的执行，或使用 goto 和标签来调整程序的执行位置。
- Go 完全省略了 if、switch 和 for 结构中条件语句两侧的括号，相比 Java、C++ 和 C# 中减少了很多视觉混乱的因素，同时也使代码更加简洁。

1. if-else 结构

   - if 是用于测试某个条件（布尔型或逻辑型）的语句，如果该条件成立，则会执行 if 后由大括号括起来的代码块，否则就忽略该代码块继续执行后续的代码。

     ```
      if condition {
        // do something
      }
     ```

   - 如果存在第二个分支，则可以在上面代码的基础上添加 else 关键字以及另一代码块，这个代码块中的代码只有在条件不满足时才会执行。if 和 else 后的两个代码块是相互独立的分支，只可能执行其中一个。

     ```
      if condition {
        // do something
      } else {
        // do something
      }
     ```

   - 如果存在第三个分支，则可以使用下面这种三个独立分支的形式：

     ```
       if condition1 {
         // do something
       } else if condition2 {
         // do something else
       } else {
         // catch-all or default
       }
     ```

   - else-if 分支的数量是没有限制的，但是为了代码的可读性，还是不要在 if 后面加入太多的 else-if 结构。如果必须使用这种形式，则把尽可能先满足的条件放在前面。
   - 即使当代码块之间只有一条语句时，大括号也不可被省略（尽管有些人并不赞成，但这还是符合了软件工程原则的主流做法）。
   - 关键字 if 和 else 之后的左大括号 { 必须和关键字在同一行，如果使用了 else-if 结构，则前段代码块的右大括号 } 必须和 else-if 关键字在同一行。这两条规则都是被编译器强制规定的。
   - 在使用 gofmt 格式化代码之后，每个分支内的代码都会缩进 4 个或 8 个空格，或者是 1 个 tab，并且右大括号与对应的 if 关键字垂直对齐。
   - 在有些情况下，条件语句两侧的括号是可以被省略的；当条件比较复杂时，则可以使用括号让代码更易读。条件允许是符合条件，需使用 &&、|| 或 !，可以使用括号来提升某个表达式的运算优先级，并提高代码的可读性。
   - 一种可能用到条件语句的场景是测试变量的值，在不同的情况执行不同的语句
   - 当 if 结构内有 break、continue、goto 或者 return 语句时，Go 代码的常见写法是省略 else 部分。无论满足哪个条件都会返回 x 或者 y 时，一般使用以下写法：

     ```
       if condition {
         return x
       }
       return y
     ```

   - 不要同时在 if-else 结构的两个分支里都使用 return 语句，这将导致编译报错。
   - if 可以包含一个初始化语句（如：给一个变量赋值）。这种写法具有固定的格式（在初始化语句后方必须加上分号）：
     ```
       if val := 10; val > max {
         // do something
       }
     ```
     - 使用简短方式 := 声明的变量的作用域只存在于 if 结构中（在 if 结构的大括号之间，如果使用 if-else 结构则在 else 代码块中变量也会存在）。
     - 如果变量在 if 结构之前就已经存在，那么在 if 结构中，该变量原来的值会被隐藏。最简单的解决方案就是不要在初始化语句中声明变量。

2. 测试多返回值函数的错误

   - Go 语言的函数经常使用两个返回值来表示执行是否成功：
     - 返回某个值以及 true 表示成功；
     - 返回零值（或 nil）和 false 表示失败。
     - 当不使用 true 或 false 的时候，也可以使用一个 error 类型的变量来代替作为第二个返回值：成功执行的话，error 的值为 nil，否则就会包含相应的错误信息（Go 语言中的错误类型为 error: var err error。
     - 就很明显需要用一个 if 语句来测试执行结果；由于其符号的原因，这样的形式又称之为“逗号 ok 模式”(comma, ok pattern)。
   - 程序应该在最接近的位置检查所有相关的错误，至少需要暗示用户有错误发生并对函数进行返回，甚至中断程序。

     ```
      value, err := pack1.Function1(param1)
      if err != nil {
        fmt.Printf("An error occured in pack1.Function1 with parameter %v", param1)
        return err
      }
      // 未发生错误，继续执行：
     ```

   - 如果我们想要在错误发生的同时终止程序的运行，我们可以使用 os 包的 Exit 函数：
     ```
       if err != nil {
         fmt.Printf("Program stopping with error %v", err)
         os.Exit(1)
       }
     ```
   - 有时候，这种习惯用法被连续重复地使用在某段代码中。当没有错误发生时，代码继续运行就是唯一要做的事情，所以 if 语句块后面不需要使用 else 分支。
   - 可以将错误的获取放置在 if 语句的初始化部分：

     ```
       if err := file.Chmod(0664); err != nil {
         fmt.Println(err)
         return err
       }
     ```

   - 或者将 ok-pattern 的获取放置在 if 语句的初始化部分，然后进行判断：

     ```
       if value, ok := readData(); ok {
       …
       }
     ```

   - 当将字符串转换为整数时，且确定转换一定能够成功时，可以将 Atoi() 函数进行一层忽略错误的封装：
     ```
       func atoi (s string) (n int) {
         n, _ = strconv.Atoi(s)
         return
       }
     ```
   - 当打印到控制台时，可以将该函数返回的错误忽略；但当输出到文件流、网络流等具有不确定因素的输出对象时，应该始终检查是否有错误发生

3. switch 结构

   - 相比较 C 和 Java 等其它语言而言，Go 语言中的 switch 结构使用上更加灵活。它接受任意形式的表达式：

     ```
       switch var1 {
         case val1:
           ...
         case val2:
           ...
         default:
           ...
       }
     ```

     - 变量 var1 可以是任何类型，而 val1 和 val2 则可以是同类型的任意值。类型不被局限于常量或整数，但必须是相同的类型；或者最终结果为相同类型的表达式。前花括号 { 必须和 switch 关键字在同一行。

     - 可以同时测试多个可能符合条件的值，使用逗号分割它们，例如：`case val1, val2, val3`。（ Go 语言使用快速的查找算法来测试 switch 条件与 case 分支的匹配情况，直到算法匹配到某个 case 或者进入 default 条件为止。）
     - 一旦成功地匹配到某个分支，在执行完相应代码后就会退出整个 switch 代码块，也就是说不需要特别使用 break 语句来表示结束。
     - 程序也不会自动地去执行下一个分支的代码。如果在执行完每个分支的代码后，还希望继续执行后续分支的代码，可以使用 fallthrough 关键字来达到目的。
     - 在 `case ...:` 语句之后，不需要使用花括号将多行语句括起来，但可以在分支中进行任意形式的编码。当代码块只有一行时，可以直接放置在 case 语句之后。
     - 同样可以使用 return 语句来提前结束代码块的执行。当在 switch 语句块中使用 return 语句，并且函数是有返回值的，还需要在 switch 之后添加相应的 return 语句以确保函数始终会返回。
     - 可选的 default 分支可以出现在任何顺序，但最好将它放在最后。它的作用类似与 if-else 语句中的 else，表示不符合任何已给出条件时，执行相关语句。

   - switch 语句的第二种形式是不提供任何被判断的值（实际上默认为判断是否为 true），然后在每个 case 分支中进行测试不同的条件。

     - 当任一分支的测试结果为 true 时，该分支的代码会被执行。这看起来非常像链式的 if-else 语句，但是在测试条件非常多的情况下，提供了可读性更好的书写方式。
     - 任何支持进行相等判断的类型都可以作为测试表达式的条件，包括 int、string、指针等。

     ```
       switch {
         case condition1:
           ...
         case condition2:
           ...
         default:
           ...
       }
     ```

   - switch 语句的第三种形式是包含一个初始化语句：

     ```
       switch result := calculate(); {
          case result < 0:
            ...
          case result > 0:
            ...
          default:
            // 0
        }
     ```

   - switch 语句还可以被用于 type-switch 来判断某个 interface 变量中实际存储的变量类型。
